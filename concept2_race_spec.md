# 📄 기획서: Concept2 로잉머신(PM5) 다중 연동 실시간 레이스 디스플레이 앱

작성일: 2026-02-06

---

## 1. 프로젝트 개요

### 1.1 목적
Concept2 로잉머신(PM5) 여러 대를 **동시에 BLE로 연결**하여, 각 사용자의 **실시간 거리 경쟁 UI**를 한 화면에 표시한다.

### 1.2 핵심 가치
- 10대 미만(2~9대) 환경에서 안정적으로 동작
- 직관적인 **트랙형 가로 그래프 레이스 UI**
- 거리 기준으로 **순위가 실시간으로 위/아래 재정렬**
- 레이스 종료 시 자동 결과 화면 + 스크린샷 저장

---

## 2. 지원 범위 및 환경

### 2.1 지원 기기
- **Android 태블릿(권장)**
  - BLE 다중 연결 안정성 및 성능 우수
- iOS는 옵션(추후)

### 2.2 지원 로잉머신
- Concept2 RowErg / SkiErg / BikeErg (PM5 기반)
- 연결 방식: **Bluetooth Low Energy (BLE)**

---

## 3. 기능 요구사항 (Feature Requirements)

### 3.1 레이스 목표 거리 설정
- 사용자는 레이스 시작 전에 목표 거리를 설정할 수 있다.
- 기본 프리셋:
  - 200m / 500m / 1000m / 2000m
- 직접 입력:
  - 100m ~ 10,000m 범위

---

### 3.2 로잉머신 연결 및 참가자 설정

#### 연결 방식
- 로잉머신을 **순서대로 1대씩 연결**
- 연결 후 참가자 정보를 설정

#### 참가자 설정 항목
- 이름(필수)
- 레인 번호(자동 부여)
- 기기 연결 상태 표시

#### 연결 UI 요구
- 연결 대기 중: `스캔 중…`
- 발견됨: `PM5 발견`
- 연결됨: `연결 완료`
- 끊김: `연결 끊김 (재연결 중)`

---

### 3.3 확인 화면 + 대기
- 참가자 목록 및 목표 거리 확인
- `대기 시작` 버튼 제공
- 대기 화면에서는:
  - 각 로잉머신에서 데이터가 들어오는지 감지
  - `준비됨 / 미준비` 상태 표시

---

### 3.4 자동 시작 조건
사용자가 `대기 시작` 이후,

- **첫 번째 데이터가 들어오는 순간 레이스 UI로 자동 전환**
- (옵션) `3,2,1 카운트다운` 적용 가능

---

### 3.5 실시간 경쟁 UI (트랙형 가로 그래프)

#### UI 형태
- 참가자별 1개 레인(Row) 제공
- 화면은 가로 트랙 형태로 구성

예시 구성:
- 왼쪽: 참가자 이름 + 현재 순위
- 중앙: 가로 트랙(진행 바)
- 오른쪽: 거리(m), SPM, Watts, 시간(선택)

---

### 3.6 실시간 순위 재정렬 (핵심 요구)
- 기준: **현재 누적 거리(m)**
- 거리가 가장 높은 참가자가 화면 상단으로 올라감
- 순위가 바뀌면 레인이 자연스럽게 위/아래로 이동

#### 재정렬 UX 조건
- 너무 자주 튀는 느낌 방지(둘 중 하나 적용)
  - 최소 0.5m 이상 차이 발생 시 재정렬
  - 또는 0.3초 단위 업데이트 + 애니메이션 이동

---

### 3.7 레이스 종료 조건
- 목표 거리 도달 시 완주 처리
- 모든 참가자가 완주하면 자동으로 결과 화면으로 전환

완주 처리 기준:
- 누적 거리 >= 목표 거리

---

### 3.8 결과 화면
#### 표시 항목
- 최종 순위(1~N)
- 각 참가자:
  - 이름
  - 완주 거리(목표값)
  - 기록 시간(가능 시)
  - 평균 페이스 또는 평균 watts(가능 시)

---

### 3.9 자동 캡쳐 및 사진첩 저장
- 결과 화면이 뜨는 순간 자동으로 스크린샷 캡쳐
- 사진첩에 저장

저장 파일명 예시:
- `Concept2_Race_2026-02-06_20-12.png`

---

### 3.10 초기화 및 재시작
결과 화면에서 제공:
- `처음으로` 버튼
- 누르면:
  - 연결 해제(옵션)
  - 참가자 정보 초기화
  - 목표 거리 설정 화면으로 이동

---

## 4. 전체 플로우 (요구사항 그대로 반영)

1. 목표 길이 설정  
2. 로잉머신 순서대로 연결 및 이름 설정  
3. 확인 후 대기  
4. 데이터 들어오기 시작하면 경쟁 UI 자동 표시  
5. 모두 완료되면 결과 표시  
6. 동시에 캡쳐 후 사진첩 저장  
7. `처음으로` 버튼 제공  

---

## 5. 화면 구성 (Screen Spec)

### 5.1 목표 거리 설정 화면
- 목표 거리 프리셋 버튼
- 직접 입력
- `다음` 버튼

---

### 5.2 로잉머신 연결 + 이름 설정 화면
- 연결된 기기 리스트
- `기기 추가(스캔)` 버튼
- 각 레인별:
  - 이름 입력
  - 연결 상태
- `완료` 버튼

---

### 5.3 확인 + 대기 화면
- 목표 거리 표시
- 참가자 목록 표시
- 각 참가자: 준비 상태 표시
- `대기 시작` 버튼

---

### 5.4 실시간 경쟁 화면 (트랙 UI)
- 상단: 목표 거리 + 경과 시간
- 중앙: 레인(참가자 수만큼)
- 레인은 거리 순으로 자동 재정렬

---

### 5.5 결과 화면
- 최종 순위 리스트
- 자동 캡쳐 진행 표시(짧게)
- `처음으로` 버튼

---

## 6. 데이터 요구사항

각 로잉머신에서 실시간 수집할 데이터:

### 필수
- 누적 거리(m)

### 권장
- elapsed time (경과 시간)
- SPM (분당 스트로크 수)
- watts (현재 파워)

### 선택
- pace (/500m)
- stroke count

---

## 7. 비기능 요구사항 (Non-Functional Requirements)

### 7.1 성능
- 참가자 최대 9명 기준
- 데이터 업데이트 0.2~0.5초 단위

### 7.2 안정성
- 연결 끊김 시 자동 재연결 시도
- 끊긴 동안 UI는 마지막 값 유지 + 상태 표시

---

## 8. **블루투스 연결 안정성 요구사항 (추가 핵심 조건)**

### 8.1 다중 BLE 연결 안정성 목표
- 동시에 **2~9대 PM5**를 연결했을 때 끊김 없이 동작해야 한다.
- 단, 환경(전자파/거리/OS)에 따라 끊김이 발생할 수 있으므로 앱은 다음을 필수로 지원한다.

---

### 8.2 연결 상태머신(필수)
각 기기는 아래 상태를 가져야 한다.

- `DISCONNECTED`
- `SCANNING`
- `CONNECTING`
- `CONNECTED`
- `SUBSCRIBED(데이터 수신 중)`
- `RECONNECTING`
- `FAILED`

---

### 8.3 자동 재연결 정책(필수)
- 연결이 끊기면 즉시 `RECONNECTING`으로 전환
- 재연결 시도는 다음 정책을 따른다.
  - 1~3회: 즉시 재시도(짧은 딜레이)
  - 4회 이상: 지수 백오프(예: 2s, 4s, 8s…)
  - 최대 재시도 시간: 60초
- 60초 이상 실패 시 `FAILED`로 전환하고 UI에 명확히 표시

---

### 8.4 스캔/연결 UX(필수)
- 스캔 중에도 사용자는 현재 연결된 기기들을 확인할 수 있어야 한다.
- 스캔 결과에 PM5가 다수 등장할 수 있으므로:
  - 기기 이름 + BLE 주소 일부 표시
  - 사용자가 원하는 기기를 정확히 선택 가능해야 한다.

---

### 8.5 현장 운영 안정성(필수 가이드)
- PM5가 ErgData 앱(또는 다른 앱)과 이미 연결 중이면 BLE 연결이 불안정할 수 있다.
- 앱 시작 시 다음 안내를 표시한다.
  - `원활한 연결을 위해 ErgData 및 다른 BLE 앱 연결을 해제해주세요.`

---

### 8.6 데이터 수신 안정성(필수)
- 연결만 된 상태가 아니라 **데이터 characteristic 구독 성공 여부**를 별도로 체크해야 한다.
- `CONNECTED`이지만 데이터가 일정 시간(예: 3초) 들어오지 않으면:
  - 자동으로 재구독 시도
  - 실패 시 재연결 시도

---

### 8.7 권장 하드웨어 조건(권장)
- Android 태블릿
- BLE 5.0 이상
- RAM 6GB 이상 권장
- 화면 출력이 목적이므로 10~13인치 권장

---

## 9. MVP 범위 (1차 출시 기준)

### 포함
- 목표 거리 설정
- BLE 다중 연결
- 이름 설정
- 실시간 거리 기반 트랙 UI
- 순위 재정렬
- 종료 후 결과 + 자동 캡쳐 저장
- 초기화

### 제외(추후)
- iOS 안정화
- 팀전(2vs2)
- 서버 기록 저장
- 결과 공유(카카오톡 등)

---
